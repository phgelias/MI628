---
title: "MI628 - Lista 3"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(123)
```

# Pacotes e Funções

```{r utils, warning=FALSE}
# PACOTES
library(Matching)
library(tidyverse)
```

# Questão 2

```{r q2}
df_multicenter <- read_csv("https://dataverse.harvard.edu/api/access/datafile/7440246")

n_controle <- sum(df_multicenter$n0)
n_1mg <- sum(df_multicenter$n1)
n_5mg <- sum(df_multicenter$n5)

total_1mg <- n_controle + n_1mg

df_multicenter_1mg <- df_multicenter %>% 
  select(colnames(df_multicenter)[!str_detect(colnames(df_multicenter), "5$")]) %>% 
  mutate(pi_k = (n0+n1)/total_1mg,
         tau_k = mean1 - mean0,
         var_k = sd1^2 / n1 + sd0^2 / n0)

tau_s_1mg <- sum(df_multicenter_1mg$pi_k * df_multicenter_1mg$tau_k)
v_s_1mg <- sum(df_multicenter_1mg$pi_k^2 * df_multicenter_1mg$var_k)

lim_inf_1mg <- tau_s_1mg - 1.96*sqrt(v_s_1mg)
lim_sup_1mg <- tau_s_1mg + 1.96*sqrt(v_s_1mg)
c(lim_inf_1mg, lim_sup_1mg)

est_s_1mg <- tau_s_1mg/sqrt(v_s_1mg)

2 - 2 * pnorm(abs(est_s_1mg))

total_5mg <- n_controle + n_5mg

df_multicenter_5mg <- df_multicenter %>% 
  select(colnames(df_multicenter)[!str_detect(colnames(df_multicenter), "1$")]) %>% 
  mutate(pi_k = (n0+n5)/total_5mg,
         tau_k = mean5 - mean0,
         var_k = sd5^2 / n5 + sd0^2 / n0)

tau_s_5mg <- sum(df_multicenter_5mg$pi_k * df_multicenter_5mg$tau_k)
v_s_5mg <- sum(df_multicenter_5mg$pi_k^2 * df_multicenter_5mg$var_k)

lim_inf_5mg <- tau_s_5mg - 1.96*sqrt(v_s_5mg)
lim_sup_5mg <- tau_s_5mg + 1.96*sqrt(v_s_5mg)
c(lim_inf_5mg, lim_sup_5mg)

est_s_5mg <- tau_s_5mg/sqrt(v_s_5mg)

2 - 2 * pnorm(abs(est_s_5mg))

```

# Questão 3

```{r q3_data}
data("lalonde")

lalonde <- lalonde %>% 
  mutate(race = ifelse(black == 1, "black",
                       ifelse(hisp == 1, "hisp", "other")))

z <- lalonde$treat
x1 <- lalonde$race
y <- lalonde$re78

n <- nrow(lalonde)
n1 <- sum(z)
n0 <- n - n1
tau <- mean(y[z == 1]) - mean(y[z == 0])
s2 = var(y)
```


```{r q3_frt}
# FRT 
est_teste_frt <- tau/sqrt(n*s2/(n1*n0))
pvalor_frt_clt <- 2 - 2*pnorm(est_teste_frt) # Bilateral

# FRT Monte Carlo
mc <- 10^4
est_teste_frt_mc <- rep(0, mc)
for (i in 1:mc) {
  zpermut <- sample(z)
  tau_permut <- mean(y[zpermut == 1]) - mean(y[zpermut == 0])
  est_teste_frt_mc[i] <- tau_permut/sqrt(n*s2/(n1*n0))
}
pvalor_frt_mc <- mean(abs(est_teste_frt_mc) > abs(est_teste_frt))


z_permuta_SRE <- function(z, x) {
  x_levels <- unique(x)
  K <- length(x_levels)
  z_perm <- z
  for (k in 1:K) {
    x_k <- x_levels[k]
    z_perm[x == x_k] <- sample(z[x == x_k])
  }
  return(z_perm)
}

ee <- function(y, z, x) {
  x_levels <- unique(x)
  K <- length(x_levels)
  pi_k <- rep(0, K)
  tau_k <- rep(0, K)
  n <- length(z)
  for (k in 1:K) {
    x_k <- x_levels[k]
    z_k <- z[x == x_k]
    y_k <- y[x == x_k]
    pi_k[k] <- length(z_k)/n
    tau_k[k] <- mean(y_k[z_k == 1]) - mean(y_k[z_k == 0])
  }
  tau_S <- sum(pi_k * tau_k)
  return(tau_S)
}

mc <- 10^4
estatisticas <- matrix(NA, ncol = 2, nrow = mc)
for (i in 1:mc) {
  z_perm <- z_permuta_SRE(z, x1)
  estatisticas[i, 1] <- ee(y, z_perm, x1)
}

ee_obs <- ee(y, z, x1)

mean(estatisticas[, 1] < ee_obs)

x2 <- lalonde$married

estatisticas_x2 <- matrix(NA, ncol = 2, nrow = mc)
for (i in 1:mc) {
  z_perm <- z_permuta_SRE(z, x2)
  estatisticas_x2[i, 1] <- ee(y, z_perm, x2)
}

ee_obs_x2 <- ee(y, z, x2)

mean(estatisticas_x2[, 1] < ee_obs_x2)

x3 <- lalonde$nodegr

estatisticas_x3 <- matrix(NA, ncol = 2, nrow = mc)
for (i in 1:mc) {
  z_perm <- z_permuta_SRE(z, x3)
  estatisticas_x3[i, 1] <- ee(y, z_perm, x3)
}

ee_obs_x3 <- ee(y, z, x3)

mean(estatisticas_x3[, 1] < ee_obs_x3)
```

```{r q3_neyman}
# CRE
tau_hat <- mean(y[z == 1]) - mean(y[z == 0])
V_hat <- var(y[z == 1]) / n1 + var(y[z == 0]) / n0
se_hat <- sqrt(V_hat)

est_neyman <- tau_hat/se_hat

neyman_sre <- function(y, z, x) {
  x_levels <- unique(x)
  K <- length(x_levels)
  pi_k <- rep(0, K)
  tau_k <- rep(0, K)
  v_k <- rep(0, K)
  n <- length(z)
  for (k in 1:K) {
    x_k <- x_levels[k]
    z_k <- z[x == x_k]
    y_k <- y[x == x_k]
    pi_k[k] <- length(z_k)/n
    tau_k[k] <- mean(y_k[z_k == 1]) - mean(y_k[z_k == 0])
    v_k[k] <- var(y_k[z_k == 1]) / sum(z_k) + var(y_k[z_k == 0]) / sum(1 - z_k)
  }
  tau_s <- sum(pi_k * tau_k)
  v_s <- sum(pi_k^2 * v_k) 
   
  return(c(tau_s, v_s))
}

est_x1 <- neyman_sre(y, z, x1)

est_x1[1]/sqrt(est_x1[2])

est_x2 <- neyman_sre(y, z, x2)

est_x2[1]/sqrt(est_x2[2])

est_x3 <- neyman_sre(y, z, x3)

est_x3[1]/sqrt(est_x3[2])
```

# Questão 6

```{r q6_dados}
dados <- read.table("https://dataverse.harvard.edu/api/access/datafile/7440282")

y <- log(dados$duration)
z <- dados$treatment
k <- dados$quarter
k_levels <- unique(k)
x <- dados[, -c(1, 2, 10)]
x <- scale(x)

n <- nrow(dados)
```

```{r q6_sala}
ee <- function(y, z, x) {
  
  x_levels <- unique(x)
  K <- length(x_levels)
  pi_k <- rep(0, K)
  tau_k <- rep(0, K)
  var_k <- rep(0, K)
  n <- length(z)
  for (k in 1:K) {
    x_k <- x_levels[k]
    z_k <- z[x == x_k]
    y_k <- y[x == x_k]
    n_k <- length(z_k)
    n_k1 <- sum(z_k)
    n_k0 <- n_k - n_k1
    pi_k[k] <- n_k/n
    tau_k[k] <- mean(y_k[z_k == 1]) - mean(y_k[z_k == 0])
    s2_k <- var(y_k)
    var_k[k] <- n_k * s2_k/(n_k1*n_k0)
  }
  
  tau_S <- sum(pi_k * tau_k)
  var_S <- sum(pi_k^2 * var_k)
  
  return(c(tau_S, var_S))
  
}

ee_obs <- ee(y, z, k)

lim_inf <- ee_obs[1] - 1.96*sqrt(ee_obs[2])
lim_sup <- ee_obs[1] + 1.96*sqrt(ee_obs[2])

ic_frt <- c(lim_inf, lim_sup)

neyman_sre <- function(y, z, x) {
  
  x_levels <- unique(x)
  K <- length(x_levels)
  pi_k <- rep(0, K)
  tau_k <- rep(0, K)
  v_k <- rep(0, K)
  n <- length(z)
  
  for (k in 1:K) {
    x_k <- x_levels[k]
    z_k <- z[x == x_k]
    y_k <- y[x == x_k]
    pi_k[k] <- length(z_k)/n
    
    modelo_k <- lm(y_k ~ z_k)
    
    tau_k[k] <- coef(modelo_k)[2]
    v_k[k] <- car::hccm(modelo_k, type = "hc2")[2, 2]
    
  }
  
  tau_s <- sum(pi_k * tau_k)
  v_s <- sum(pi_k^2 * v_k) 
  
  return(c(tau_s, v_s))
  
}

est_neyman <- neyman_sre(y, z, k)
lim_inf <- est_neyman[1] - 1.96*sqrt(est_neyman[2])
lim_sup <- est_neyman[1] + 1.96*sqrt(est_neyman[2])
ic_neyman <- c(lim_inf, lim_sup)
```

```{r q6_imp}
K <- length(k_levels)
pi_k <- rep(0, K)
tau_k <- rep(0, K)
var_k <- rep(0, K)
  
for (estrato in sort(k_levels)) {
  x_k <- x[k == estrato, ]
  z_k <- z[k == estrato]
  y_k <- y[k == estrato]
  pi_k[estrato] <- length(z_k)/n
    
  modelo_k <- lm(y_k ~ z_k*x_k)
    
  tau_k[estrato] <- coef(modelo_k)[2]
  var_k[estrato] <- car::hccm(modelo_k, type = "hc2")[2, 2]
    
}
  
tau_S <- sum(pi_k * tau_k)
  
se_S <- sqrt(sum(pi_k^2 * var_k))

lim_inf <- tau_S - 1.96 * se_S
lim_sup <- tau_S + 1.96 * se_S

ic_rem <- c(lim_inf, lim_sup)

ic_frt
ic_neyman
ic_rem
```

